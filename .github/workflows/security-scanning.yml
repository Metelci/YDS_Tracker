name: Security Scanning

on:
  push:
    branches: [ main, ui-m3-migration, develop ]
  pull_request:
    branches: [ main, ui-m3-migration ]
  schedule:
    # Run security scan daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  security-scan:
    name: Comprehensive Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      security-events: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run Dependency Vulnerability Scan (OWASP)
        id: dependency-check
        run: ./gradlew dependencyCheckAnalyze
        continue-on-error: true

      - name: Upload Dependency Check Results
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: app/build/reports/dependency-check/
          retention-days: 30
          if-no-files-found: warn

      - name: Check for Hardcoded Secrets
        id: secret-scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified
        continue-on-error: true

      - name: Run Android Lint Security Checks
        id: android-lint
        run: ./gradlew lintDebug --continue
        continue-on-error: true

      - name: Upload Lint Report
        uses: actions/upload-artifact@v4
        with:
          name: android-lint-report
          path: app/build/reports/lint-results-debug.html
          retention-days: 30
          if-no-files-found: warn

      - name: SAST Analysis - Semgrep
        id: semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/android
            p/kotlin
          generateSarif: true
        continue-on-error: true

      - name: Upload SARIF for CodeQL
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: semgrep.sarif
          wait-for-processing: true
        continue-on-error: true

      - name: Build Security Report Summary
        if: always()
        run: |
          echo "## ðŸ”’ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Dependency Check**: ${{ steps.dependency-check.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Secret Scanning**: ${{ steps.secret-scan.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Android Lint**: ${{ steps.android-lint.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "- **SAST (Semgrep)**: ${{ steps.semgrep.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- [Dependency Check Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "- [Android Lint Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY

      - name: Comment on PR with Security Results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const dependencyCheck = '${{ steps.dependency-check.outcome }}' === 'success' ? 'âœ…' : 'âš ï¸';
            const secretScan = '${{ steps.secret-scan.outcome }}' === 'success' ? 'âœ…' : 'âš ï¸';
            const lintCheck = '${{ steps.android-lint.outcome }}' === 'success' ? 'âœ…' : 'âš ï¸';
            const semgrep = '${{ steps.semgrep.outcome }}' === 'success' ? 'âœ…' : 'âš ï¸';

            const comment = `## ðŸ”’ Security Scan Report

            | Check | Status |
            |-------|--------|
            | Dependency Vulnerability Check | ${dependencyCheck} |
            | Secrets Detection | ${secretScan} |
            | Android Lint Security | ${lintCheck} |
            | SAST Analysis (Semgrep) | ${semgrep} |

            ðŸ“Š Detailed reports are available in the [Actions artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            })

  container-scan:
    name: Container Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image for scanning
        run: |
          # Create a minimal Dockerfile for scanning
          cat > Dockerfile << 'EOF'
          FROM gradle:8.7.2-jdk17
          WORKDIR /app
          COPY . .
          RUN ./gradlew build --no-daemon || true
          EOF

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: 'app/build'
          format: 'sarif'
          output: 'trivy-results.sarif'
        continue-on-error: true

      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
        continue-on-error: true

  sca-license-check:
    name: Software Composition Analysis & License Compliance
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission
        run: chmod +x gradlew

      - name: Generate Dependency License Report
        id: license-check
        run: |
          ./gradlew dependencies > dependencies.txt 2>&1 || true
          echo "Dependency analysis complete"
        continue-on-error: true

      - name: Upload Dependencies List
        uses: actions/upload-artifact@v4
        with:
          name: dependencies-report
          path: dependencies.txt
          retention-days: 30

  security-summary:
    name: Security Summary & Reporting
    needs: [security-scan]
    runs-on: ubuntu-latest
    if: always()
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Determine Overall Status
        run: |
          if [ "${{ needs.security-scan.result }}" == "failure" ]; then
            echo "SECURITY_STATUS=ðŸ”´ FAILED" >> $GITHUB_ENV
            exit 1
          else
            echo "SECURITY_STATUS=âœ… PASSED" >> $GITHUB_ENV
          fi

      - name: Report Status
        run: |
          echo "## Security Scan Status: ${{ env.SECURITY_STATUS }}"
          echo ""
          echo "All security checks completed. Please review artifacts for details."
